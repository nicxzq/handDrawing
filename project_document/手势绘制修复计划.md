# 手势绘制问题修复计划

## 背景与现象
- 摄像头能正确识别手势捏合与松开（`CameraView` 的状态与日志均可见），但捏合时未在画布上产生笔迹，松开时未“提笔”。
- 期望：在“Draw Mode”下，拇指+食指捏合即开始在 `DrawingCanvas` 上绘制；松开时结束当前路径。

## 代码链路综述（现状）
- `CameraView`：基于 MediaPipe Hands 识别捏合/松开 → 在 `isDrawingMode===true` 时调用父层回调 `onDrawStart/onDrawMove/onDrawEnd`。
- `app/page.tsx`：回调 `handleDrawStart/handleDrawMove/handleDrawEnd` → 通过 `DrawingCanvasRef` 调用 `DrawingCanvas.startDrawing/draw/stopDrawing`。
- `DrawingCanvas`：真正完成路径记录与绘制；当 `tool` 为非绘制类工具时，`startDrawing` 会早退或走其他逻辑（如 `bucket/eyedropper/text/shape/select/pan`）。

## 根因分析（优先级由高到低）
1) Draw Mode 未“强制绘图工具”导致的早退
   - `startDrawing` 会对 `tool` 做分支：若当前工具为 `bucket/eyedropper/text/shape/select/pan`，则直接执行该工具逻辑或早退，不进入绘制状态（`isDrawing` 不会被置为 true）。
   - 结果：即便 `CameraView` 捏合正确，`DrawingCanvas.draw` 因 `!isDrawing` 被跳过，画面没有笔迹；`stopDrawing` 也可能因没有路径而跳过“提笔”收尾。

2) 工具态与手势态未解耦
   - 目前 `CameraView` 的“Draw Mode/Tool Mode”仅决定是否触发 `onDraw*`，但不干预 `currentTool`。
   - 用户若上一次使用了非绘制工具（如 `pan`/`bucket`），进入 Draw Mode 后未自动切到可绘制工具，导致捏合不出线。

3) 手丢失/边界条件触发时的收尾一致性
   - 丢手时已有调用 `triggerDrawEnd()`，但若之前未进入绘制态（见原因1），结束逻辑会被 `DrawingCanvas.stopDrawing` 的保护条件跳过（`!isDrawing || currentPath.length===0`），主观体验为“松开不提笔”。

4) 坐标映射/多画布选择的脆弱点（次要）
   - `CameraView.getDrawingCanvasRect()` 通过 `document.querySelector("canvas.touch-none")` 获取画布，若未来存在多个匹配或类名变更，可能映射异常。
   - 当前项目仅有一个主画布，短期不是触发本问题的主因，但建议加固选择器或透传 `ref`。

## 修改目标
- 在 Draw Mode 下，保证捏合必然进入绘制态；松开必然结束绘制路径。
- 不破坏用户在 Tool Mode 的正常工具行为。
- 对边界场景（丢手、越界）保持收尾一致性。

## 方案设计
A. Draw Mode 下的工具强制策略（最小侵入）
- 在 `app/page.tsx` 的 `handleDrawStart` 内：
  - 若当前 `currentTool` 非绘制类（`brush|pen|marker|highlighter|eraser`），临时切换到上次“绘制工具”或默认 `brush`，并记录 `prevToolBeforeGesture`。
  - 在 `handleDrawEnd` 成功结束后，若处于 Draw Mode，则将 `currentTool` 恢复为 `prevToolBeforeGesture`（若存在）。
- 好处：
  - 无需修改 `DrawingCanvas` 的行为约束；
  - 对 Tool Mode 行为零影响；
  - 对用户体验贴近“捏合即绘”的直觉。

B. 统一“手势绘制会话”状态
- 在 `app/page.tsx` 维护 `isGestureSessionActive` 与 `prevToolBeforeGesture`：
  - Pinch开始：若进入绘制，置 `isGestureSessionActive=true`；
  - 松开/丢手：结束后清空会话并尝试恢复工具。

C. 加固收尾逻辑
- `CameraView` 已在“无手”时触发 `onDrawEnd`，保持不变；
- `DrawingCanvas.stopDrawing` 已容错 `!isDrawing || currentPath.length===0`，本次不改；当 A 实施后，正常路径将具备点集，结束生效。

D. 选择器加固（可选增强）
- `CameraView.getDrawingCanvasRect()` 改为：
  - 优先查找 `#main-drawing-canvas`；找不到再回退 `canvas.touch-none`。
- 同步在 `DrawingCanvas` 的根 `<canvas>` 增加 `id="main-drawing-canvas"`。

## 影响评估
- 与渲染/性能：变更仅在交互层，不影响绘制算法与渲染链路。
- 与现有 UI：Draw Mode 下的“强制绘图工具”仅在会话内生效，结束即恢复，符合用户直觉。
- 回滚风险：均为局部可控改动，易回退。

## 实施清单（Checklist）
1. `app/page.tsx`：在组件状态中新增：
   - `const [isGestureSessionActive, setIsGestureSessionActive] = useState(false)`
   - `const [prevToolBeforeGesture, setPrevToolBeforeGesture] = useState<string | null>(null)`
2. `app/page.tsx`：在 `handleDrawStart` 中：
   - 若 `isDrawingMode` 为真且 `currentTool` 非 `brush|pen|marker|highlighter|eraser`，则：
     - 记录 `prevToolBeforeGesture=currentTool`
     - `setCurrentTool(lastDrawingToolRef.current ?? "brush")`（新增 `lastDrawingToolRef`，在每次工具切到绘制类时更新）
   - 调用 `drawingCanvasRef.current.startDrawing(x, y, 1)`；`setIsGestureSessionActive(true)`
3. `app/page.tsx`：在 `handleDrawMove` 中保持不变（仅调用 `draw`）。
4. `app/page.tsx`：在 `handleDrawEnd` 中：
   - 调用 `stopDrawing()`；
   - 若 `isGestureSessionActive` 为真，则：
     - `setIsGestureSessionActive(false)`；
     - 若存在 `prevToolBeforeGesture` 且仍处于 Draw Mode，则 `setCurrentTool(prevToolBeforeGesture)` 并置空 `prevToolBeforeGesture`。
5. `app/page.tsx`：维护 `lastDrawingToolRef`：
   - 在工具切换时（键盘/面板/手势），若新工具属于绘制类（含 `eraser`），更新 `lastDrawingToolRef.current`。
6. `components/drawing-canvas.tsx`（可选增强 D）：为 `<canvas>` 增加 `id="main-drawing-canvas"`。
7. `components/camera-view.tsx`（可选增强 D）：
   - `getDrawingCanvasRect()` 优先 `document.getElementById("main-drawing-canvas")`，找不到再回退现有选择器。
8. 验证用例：
   - Draw Mode 下，工具为 `pan` → 捏合应自动以 `brush`（或上次绘制工具）绘画；松开提笔并恢复到 `pan`；
   - 工具为 `bucket/eyedropper/text/shape/select` → 同上；
   - 工具为 `eraser` → 捏合应擦除；
   - Tool Mode 下 → 捏合不触发绘制（行为与现状一致）。

## 测试清单
- 手动测试 6 种工具状态下的捏合/松开行为（含丢手场景）。
- 观察日志：`[MainApp]` 与 `[DrawingCanvas]` 输出应体现“进入绘制/追加点/结束绘制”。
- 视觉确认：路径应在捏合期间实时出现，松开后不再追加点。

## 交付物
- 代码变更（上述 1-7 项）。
- 本文档作为修改计划归档至 `project_document/手势绘制修复计划.md`。 